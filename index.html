<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDK SmartLogger - BLEÊ∏©Â∫¶„É≠„Ç¨„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        @media (min-width: 600px) {
            .container {
                max-width: 600px;
                margin: 0 auto;
                width: 66.67%;
            }
        }

        .header {
            color: white;
            margin-bottom: 30px;
        }

        .header-content {
            position: relative;
            margin-bottom: 20px;
        }

        .title-area {
            text-align: center;
            margin: 0 auto;
            padding: 0px;
        }

        .header h1 {
            font-size: 2.0rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #ff4757;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background-color: #2ed573;
            box-shadow: 0 0 10px rgba(46, 213, 115, 0.5);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card h2 {
            color: #2c3e50;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .card-title {
            display: flex;
        }

        .connect-section {
            text-align: center;
        }

        .connect-card {
            text-align: center;
            margin-bottom: 20px;
        }

        .connect-btn {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
        }

        .connect-btn:hover {
            background: linear-gradient(135deg, #96c93d 0%, #00b09b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
        }

        .collect-data-btn {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .collect-data-btn:hover {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.3);
        }

        .collect-data-btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.2);
        }

        .collect-data-btn::before {
            content: "üì•";
            font-size: 1.4rem;
        }

        .sensor-grid {
            display: grid;
            grid-template-rows: 1.5fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .sensor-value {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sensor-icon {
            color: #ff0000;
            font-size: 3.0rem;
        }

        .sensor-content {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .value-container {
            display: flex;
            align-items: baseline;
        }

        .sensor-value .value {
            font-size: 4.0rem;
            font-weight: bold;
            color: #333;
        }

        .sensor-value .unit {
            font-size: 2.0rem;
            color: #666;
            margin-left: 8px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .history-section {
            margin-top: 20px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .history-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e8ed;
        }

        .history-table tr:hover {
            background-color: #f8f9fa;
        }

        .error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .disconnect-btn {
            position: absolute;
            right: 0;
            top: calc(50% + 35px);
            transform: translateY(-50%);
            background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%);
            color: white;
            padding: 8px 15px;
            font-size: 1.0rem;
            font-weight: 600;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
            display: none;
            transition: all 0.3s ease;
        }

        .disconnect-btn:hover {
            background: linear-gradient(135deg, #ff6b81 0%, #ff4757 100%);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }

        .status-text {
            color: #2c3e50;
            font-size: 1.0rem;
            font-weight: 600;
        }

        .battery-icon {
            width: 32px;
            height: 16px;
            border: 2px solid #2c3e50;
            border-radius: 3px;
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }

        .battery-icon::after {
            content: '';
            width: 3px;
            height: 8px;
            background: #2c3e50;
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 0 2px 2px 0;
        }

        .battery-icon .level {
            height: 100%;
            background: #2ed573;
            transition: width 0.3s ease;
        }

        .battery-icon.low .level {
            background: #ff4757;
        }

        .battery-icon.medium .level {
            background: #ffa502;
        }

        .battery-icon.unknown::before {
            content: '?';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #2c3e50;
            font-weight: bold;
            font-size: 12px;
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .message-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 80%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .message {
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            pointer-events: auto;
            color: white;
            opacity: 1;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.95);
        }

        .message.success {
            background: rgba(39, 174, 96, 0.95);
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Çπ„Çø„Ç§„É´„ÅØ„Åì„Åì„Åæ„Åß */
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="title-area">
                    <h1>HDK SmartLogger</h1>
                    <p>BLEÊ∏©Â∫¶„Éá„Éº„Çø„É≠„Ç¨„Éº</p>
                </div>
                <button class="disconnect-btn" onclick="disconnectDevice()" style="display: none;">ÂàáÊñ≠</button>
            </div>
            <div id="connectionStatus" style="margin-top: 15px; color: white;"></div>
        </div>
        <div class="status-bar">
            <div class="status-text">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="connectionText">Êú™Êé•Á∂ö</span>
            </div>
            <div class="status-right">
                <span class="status-text"><span id="statusTime">--:--:--</span></span>
                <div class="battery-icon unknown" id="batteryIcon">
                    <div class="level" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="connect-card">
            <button class="connect-btn" onclick="connectToDevice()">„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö</button>
        </div>
        <div class="card" id="sensorCard" style="display: none;">
            <div class="card-title">
                <span class="sensor-icon">üå°</span>
                <h2>ÁèæÂú®Ê∏©Â∫¶</h2>
            </div>
            <div class="sensor-value">
                <div class="sensor-content">
                    <div class="value-container">
                        <span class="value" id="temperatureValue">--.-</span>
                        <span class="unit">‚ÑÉ</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" id="dataMeterCard" style="display: none;">
            <div class="card-title">
                <div class="sensor-icon">üìä</div>
                <h2>Ë®àÊ∏¨„Éá„Éº„Çø</h2>
            </div>
            <div class="sensor-grid">
                <div class="sensor-value">
                    <div class="sensor-content">
                        <div class="value-container">
                            <span class="value" id="dataCount">0</span>
                            <span class="unit">‰ª∂</span>
                        </div>
                    </div>
                </div>
                <button class="collect-data-btn" onclick="loadHistoricalData()">
                    <span class="btn-label">„Éá„Éº„ÇøÂõûÂèéÈñãÂßã</span>
                </button>
            </div>
        </div>
    </div> <!-- .container -->
    <div id="messageContainer" class="message-container"></div>

    <script src="device_emulator.js"></script>
    <script>
        // BLEÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let device = null;
        let server = null;
        let service = null;
        let characteristics = {};
        let useEmulator = false; // „Ç®„Éü„É•„É¨„Éº„Çø‰ΩøÁî®„Éï„É©„Ç∞

        // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÂ§âÊèõÈñ¢Êï∞
        function toDeviceTimestamp(date = new Date()) {
            const localDate = new Date(date);
            localDate.setHours(localDate.getHours() + 9);
            return Math.floor(localDate / 1000);
        }

        function fromDeviceTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            date.setHours(date.getHours() - 9);
            return date;
        }

        // URL„Éë„É©„É°„Éº„Çø„Åß„Ç®„Éü„É•„É¨„Éº„ÇøÂàá„ÇäÊõø„Åà
        function getUrlParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // „Éá„Éê„Ç§„Çπ„É¨„Éô„É´„Ç®„Éü„É•„É¨„Éº„ÇøËá™ÂãïONÔºà?emu=1Ôºâ
        if (getUrlParam('emu') === '1') {
            useEmulator = true;
        }

        // UUIDs (Arduino„Ç≥„Éº„Éâ„Å®Âêå„Åò)
        const SERVICE_UUID = "ec78dac9-a6b2-4c8d-af48-4247430b8927";
        const CHAR_UUIDS = {
            CURRENT_TIME: "c04b3159-ef9d-4042-8946-ecf7c335f3a1",
            SET_TIME: "ddc53751-9308-4489-adee-e6dd18aabea3",
            CURRENT_TEMP: "cc9e794b-2bab-476b-b603-a47a28ce41c1",
            CURRENT_HUMIDITY: "238b2fc3-877c-4d3b-8a6d-f0c796055c7e",
            CURRENT_BATTERY: "2955be57-8363-42e6-aacb-4725b4afd3d5",
            DATA_COUNT: "201485f0-0ff2-4526-9b95-1b5fa678f7ea",
            CONTROL_POINT: "9229b428-2cf4-4419-836b-d3f1f243916b",
            HISTORICAL_DATA: "a1030249-0150-499d-a7c3-51489a59c86c",
            CLEAR_HISTORICAL_DATA: "4130d566-2748-4c38-9c90-f8b7d834235f"
        };

        // „É°„ÉÉ„Çª„Éº„Ç∏ÁÆ°ÁêÜ
        const MessageManager = {
            currentMessage: null,
            currentTimeout: null,

            // „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
            show(message, type) {
                const container = document.getElementById('messageContainer');

                // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
                if (this.currentMessage) {
                    container.removeChild(this.currentMessage);
                    if (this.currentTimeout) {
                        clearTimeout(this.currentTimeout);
                    }
                }

                // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                const messageElement = this.createMessageElement(message, type);
                container.appendChild(messageElement);
                this.currentMessage = messageElement;

                // 3ÁßíÂæå„Å´ÈùûË°®Á§∫
                this.currentTimeout = setTimeout(() => this.hideMessage(), 3000);
            },

            // „É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†„ÅÆ‰ΩúÊàê
            createMessageElement(message, type) {
                const element = document.createElement('div');
                element.className = `message ${type}`;
                element.textContent = message;
                return element;
            },

            // „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈùûË°®Á§∫
            hideMessage() {
                if (!this.currentMessage) return;

                this.currentMessage.style.opacity = '0';
                setTimeout(() => {
                    if (this.currentMessage && this.currentMessage.parentNode) {
                        this.currentMessage.parentNode.removeChild(this.currentMessage);
                    }
                    this.currentMessage = null;
                    this.currentTimeout = null;
                }, 300);
            }
        };

        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
        function showError(message) {
            console.error(message);
            MessageManager.show(message, 'error');
        }

        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
        function showSuccess(message) {
            console.log(message);
            MessageManager.show(message, 'success');
        }

        // „É≠„Ç∞Âá∫Âäõ
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
        }

        // „Éê„ÉÉ„ÉÜ„É™„Ç¢„Ç§„Ç≥„É≥Ë°®Á§∫
        function updateBatteryIcon(batteryValue) {
            const batteryIcon = document.getElementById('batteryIcon');
            const level = batteryIcon.querySelector('.level');

            if (!batteryValue || batteryValue === '--') {
                batteryIcon.className = 'battery-icon unknown';
                level.style.width = '0%';
                return;
            }

            // „Éê„ÉÉ„ÉÜ„É™„ÉºÈõªÂúß„Åã„ÇâÊÆãÈáè„ÇíË®àÁÆóÔºà3.2V-4.2VÔºâ
            const minVoltage = 3200;  // 3.2V
            const maxVoltage = 4200;  // 4.2V
            let percentage = (batteryValue - minVoltage) / (maxVoltage - minVoltage) * 100;
            percentage = Math.max(0, Math.min(100, percentage));  // 0-100%„ÅÆÁØÑÂõ≤„Å´Âà∂Èôê

            // „Éê„ÉÉ„ÉÜ„É™„Éº„É¨„Éô„É´„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„ÇíË®≠ÂÆö
            if (percentage <= 20) {
                batteryIcon.className = 'battery-icon low';
            } else if (percentage <= 50) {
                batteryIcon.className = 'battery-icon medium';
            } else {
                batteryIcon.className = 'battery-icon';
            }

            level.style.width = `${percentage}%`;
        }
        
        // Êé•Á∂öÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const connectionText = document.getElementById('connectionText');
            const sensorCard = document.getElementById('sensorCard');
            const dataMeterCard = document.getElementById('dataMeterCard');
            const batteryIcon = document.getElementById('batteryIcon');
            const disconnectButton = document.querySelector('.disconnect-btn');
            const connectCard = document.querySelector('.connect-card');

            if (connected) {
                indicator.classList.add('connected');
                connectionText.textContent = 'Êé•Á∂öÊ∏à„Åø';
                sensorCard.style.display = 'block';
                dataMeterCard.style.display = 'block';
                batteryIcon.classList.remove('unknown');
                disconnectButton.style.display = 'inline-block';
                connectCard.style.display = 'none';
            } else {
                indicator.classList.remove('connected');
                connectionText.textContent = 'Êú™Êé•Á∂ö';
                sensorCard.style.display = 'none';
                dataMeterCard.style.display = 'none';
                batteryIcon.className = 'battery-icon unknown';
                const level = batteryIcon.querySelector('.level');
                if (level) {
                    level.style.width = '0%';
                }
                document.getElementById('statusTime').textContent = '--:--:--';
                disconnectButton.style.display = 'none';
                connectCard.style.display = 'block';
            }
        }
        
        // „Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö
        async function connectToDevice() {
            try {
                if (!navigator.bluetooth) {
                    throw new Error('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØWeb Bluetooth API„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }

                log('„Éá„Éê„Ç§„Çπ„ÇíÊ§úÁ¥¢‰∏≠...');

                if (useEmulator) {
                    await connectToEmulator();
                } else {
                    await connectToRealDevice();
                }

                // ÂàùÊúüË®≠ÂÆö
                updateConnectionStatus(true);
                await readAllSensorData();

            } catch (error) {
                showError(`Êé•Á∂ö„Ç®„É©„Éº: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        // „Ç®„Éü„É•„É¨„Éº„Çø„Å´Êé•Á∂ö
        async function connectToEmulator() {
            if (typeof getEmulatorDevice !== 'function') {
                throw new Error('„Ç®„Éü„É•„É¨„Éº„Çø„ÅåÊ≠£„Åó„Åè„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }

            log('„Ç®„Éü„É•„É¨„Éº„Çø„Å´Êé•Á∂ö‰∏≠...');
            device = getEmulatorDevice();
            server = await device.gatt.connect();
            service = await server.getPrimaryService(SERVICE_UUID);
            await setupCharacteristics();
            showSuccess('„Ç®„Éü„É•„É¨„Éº„Çø„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü');
        }

        // ÂÆü„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö
        async function connectToRealDevice() {
            device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'HDK_SmartLogger' }],
                optionalServices: [SERVICE_UUID]
            });

            log(`„Éá„Éê„Ç§„ÇπÁô∫Ë¶ã: ${device.name}`);
            server = await device.gatt.connect();
            service = await server.getPrimaryService(SERVICE_UUID);
            await setupCharacteristics();
            device.addEventListener('gattserverdisconnected', onDisconnected);
            showSuccess('„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü');
        }

        // Characteristics„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        async function setupCharacteristics() {
            characteristics = {};
            for (const [name, uuid] of Object.entries(CHAR_UUIDS)) {
                try {
                    characteristics[name] = await service.getCharacteristic(uuid);
                    log(`${name} characteristicÂèñÂæóÂÆå‰∫Ü`);
                } catch (err) {
                    log(`${name} characteristicÂèñÂæó„Ç®„É©„Éº: ${err.message}`);
                }
            }
        }

        // „Éá„Éê„Ç§„Çπ„Åã„ÇâÂàáÊñ≠
        async function disconnectDevice() {
            if (device && device.gatt) {
                if (useEmulator) {
                    device.gatt.disconnect();
                    onDisconnected();
                    log('„Ç®„Éü„É•„É¨„Éº„Çø„Éá„Éê„Ç§„Çπ„Åã„ÇâÂàáÊñ≠„Åó„Åæ„Åó„Åü');
                } else if (device.gatt.connected) {
                    device.gatt.disconnect();
                    log('„Éá„Éê„Ç§„Çπ„Åã„ÇâÂàáÊñ≠„Åó„Åæ„Åó„Åü');
                }
            }
        }
        
        // ÂàáÊñ≠ÊôÇ„ÅÆÂá¶ÁêÜ
        function onDisconnected() {
            log('„Éá„Éê„Ç§„Çπ„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü');
            updateConnectionStatus(false);
            // Êé•Á∂öÈñ¢ÈÄ£„ÅÆÂ§âÊï∞„Çí„ÇØ„É™„Ç¢
            device = null;
            server = null;
            service = null;
            characteristics = {};
            // „Ç®„Éü„É•„É¨„Éº„Çø„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„ÉàÔºàURL„Éë„É©„É°„Éº„Çø„ÅÆÁä∂ÊÖã„ÇíÁ∂≠ÊåÅÔºâ
            if (getUrlParam('emu') !== '1') {
                useEmulator = false;
            }
        }

        // „Çª„É≥„Çµ„Éº„Éá„Éº„Çø„ÅÆË™≠„ÅøÂèñ„Çä
        async function readAllSensorData() {
            if (!characteristics) {
                throw new Error('Characteristics„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }

            try {
                await readTemperature(),
                await readBattery(),
                await readDataCount(),
                await readDeviceTime()

                log('„Çª„É≥„Çµ„Éº„Éá„Éº„ÇøÊõ¥Êñ∞ÂÆå‰∫Ü');
            } catch (error) {
                showError(`„Éá„Éº„ÇøË™≠„ÅøÂèñ„Çä„Ç®„É©„Éº: ${error.message}`);
            }
        }

        // Ê∏©Â∫¶„ÅÆË™≠„ÅøÂèñ„Çä
        async function readTemperature() {
            if (!characteristics.CURRENT_TEMP) return;
            const value = await characteristics.CURRENT_TEMP.readValue();
            const temp = value.getInt16(0, true) / 10.0;
            document.getElementById('temperatureValue').textContent = temp.toFixed(1);
        }

        // „Éê„ÉÉ„ÉÜ„É™„Éº„ÅÆË™≠„ÅøÂèñ„Çä
        async function readBattery() {
            if (!characteristics.CURRENT_BATTERY) return;
            const value = await characteristics.CURRENT_BATTERY.readValue();
            const battery = value.getUint16(0, true);
            updateBatteryIcon(battery);
        }

        // „Éá„Éº„Çø‰ª∂Êï∞„ÅÆË™≠„ÅøÂèñ„Çä
        async function readDataCount() {
            if (!characteristics.DATA_COUNT) return;
            const value = await characteristics.DATA_COUNT.readValue();
            const count = value.getUint16(0, true);
            document.getElementById('dataCount').textContent = count;
        }

        // „Éá„Éê„Ç§„ÇπÊôÇÂàª„ÅÆË™≠„ÅøÂèñ„Çä
        async function readDeviceTime() {
            if (!characteristics.CURRENT_TIME) {
                document.getElementById('statusTime').textContent = '--:--:--';
                return;
            }
            const value = await characteristics.CURRENT_TIME.readValue();
            const timestamp = value.getUint32(0, true);
            const date = fromDeviceTimestamp(timestamp);
            document.getElementById('statusTime').textContent = date.toLocaleTimeString();
        }

        // „Éá„Éê„Ç§„ÇπÊôÇÂàª„ÇíË®≠ÂÆö
        async function setDeviceTime() {
            try {

                if (characteristics.SET_TIME) {
                    const timestamp = toDeviceTimestamp(new Date());
                    const buffer = new ArrayBuffer(4);
                    const view = new DataView(buffer);
                    view.setUint32(0, timestamp, true);
                    await characteristics.SET_TIME.writeValue(buffer);

                    // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøÂèñ„Çä
                    setTimeout(readAllSensorData, 500);
                }

            } catch (error) {
                showError(`ÊôÇÂàªË®≠ÂÆö„Ç®„É©„Éº: ${error.message}`);
            }
        }
        
        // Â±•Ê≠¥„Éá„Éº„Çø„ÇíÂèñÂæó
        async function loadHistoricalData() {
            try {
                const totalCount = await getDataCount();
                if (totalCount === 0) {
                    showError('Â±•Ê≠¥„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }

                collectedData = [];
                log(`ÂÖ®${totalCount}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åô`);

                const chunkSize = 20; // 1Âõû„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÅßÂèñÂæó„Åô„Çã„É¨„Ç≥„Éº„ÉâÊï∞
                for (let currentIndex = 0; currentIndex < totalCount; currentIndex += chunkSize) {
                    await processDataChunk(currentIndex, totalCount);
                    await new Promise(resolve => setTimeout(resolve, 100)); // „Éá„Éê„Ç§„ÇπÂá¶ÁêÜ„ÅÆ‰ΩôË£ï„ÇíÊåÅ„Åü„Åõ„Çã
                }

                if (collectedData.length > 0) {
                    showSuccess(`ÂÖ®${totalCount}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæóÂÆå‰∫Ü„Åó„Åæ„Åó„Åü`);
                    await downloadAsCSV(collectedData);

                    // „Éá„Éº„Çø„ÅÆ„ÇØ„É™„Ç¢„Å®„Éá„Éº„ÇøÊï∞Êõ¥Êñ∞
                    await clearHistoricalData();
                    await readDataCount();
                }

            } catch (error) {
                showError(`Â±•Ê≠¥„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
            }
        }

        // „Éá„Éº„Çø‰ª∂Êï∞„ÅÆÂèñÂæó
        async function getDataCount() {
            if (!characteristics.DATA_COUNT) {
                throw new Error('„Éá„Éº„Çø„Ç´„Ç¶„É≥„ÉàÁâπÊÄß„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            const value = await characteristics.DATA_COUNT.readValue();
            return value.getUint16(0, true);
        }

        // „Éá„Éº„Çø„ÉÅ„É£„É≥„ÇØ„ÅÆÂá¶ÁêÜ
        async function processDataChunk(currentIndex, totalCount) {
            await setControlPoint(currentIndex);
            const records = await readHistoricalData();
            const progress = Math.floor((Math.min(currentIndex + records, totalCount) / totalCount) * 100);
            showSuccess(`„Éá„Éº„ÇøÂèñÂæó‰∏≠... (${progress}%)`);
        }

        // „Ç≥„É≥„Éà„É≠„Éº„É´„Éù„Ç§„É≥„Éà„ÅÆË®≠ÂÆö
        async function setControlPoint(index) {
            if (!characteristics.CONTROL_POINT) return;
            const buffer = new ArrayBuffer(2);
            const view = new DataView(buffer);
            view.setUint16(0, index, true);
            await characteristics.CONTROL_POINT.writeValue(buffer);
            log(`Â±•Ê≠¥„Éá„Éº„ÇøË™≠„ÅøÂèñ„Çä „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ: ${index}`);
        }

        // Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøÂèñ„Çä
        async function readHistoricalData() {
            if (!characteristics.HISTORICAL_DATA) {
                throw new Error('Â±•Ê≠¥„Éá„Éº„ÇøÁâπÊÄß„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            const value = await characteristics.HISTORICAL_DATA.readValue();
            return parseHistoricalData(value);
        }

        // Â±•Ê≠¥„Éá„Éº„Çø„ÅÆ„ÇØ„É™„Ç¢
        async function clearHistoricalData() {
            if (!characteristics.CLEAR_HISTORICAL_DATA) return;
            const buffer = new ArrayBuffer(2);
            const view = new DataView(buffer);
            view.setUint16(0, 0x5aa5, true);
            await characteristics.CLEAR_HISTORICAL_DATA.writeValue(buffer);
            log(`Â±•Ê≠¥„Éá„Éº„Çø„ÇØ„É™„Ç¢`);
        }

        // CSV„Éï„Ç°„Ç§„É´„ÅÆ‰ΩúÊàê„Å®„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        async function downloadAsCSV(data) {
            try {
                const csvContent = generateCSVContent(data);
                const filename = generateCSVFilename();
                const blob = await createCSVBlob(csvContent);

                await downloadFile(blob, filename);
                showSuccess(`CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü: ${filename}`);
            } catch (error) {
                showError(`CSV„Éï„Ç°„Ç§„É´‰ΩúÊàê„Ç®„É©„Éº: ${error.message}`);
            }
        }

        // CSV„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÁîüÊàê
        function generateCSVContent(data) {
            const headers = "Ê∏¨ÂÆöÊó•ÊôÇ,Ê∏©Â∫¶(‚ÑÉ)\n";
            const rows = data.map(row => {
                const date = fromDeviceTimestamp(row.timestamp);
                const dateStr = formatDate(date);
                const temp = (row.temperature / 10.0).toFixed(1);

                return `${dateStr},${temp}`;
            }).join('\n');

            return headers + rows;
        }

        // Êó•‰ªò„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDate(date) {
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '/');
        }

        // CSV„Éï„Ç°„Ç§„É´Âêç„ÅÆÁîüÊàê
        function generateCSVFilename() {
            const now = new Date();
            const timestamp = now.getFullYear() +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0') +
                String(now.getSeconds()).padStart(2, '0');
            return `SmartLogger_${timestamp}.csv`;
        }

        // UTF-8 with BOMÂΩ¢Âºè„ÅÆBlob„ÅÆ‰ΩúÊàê
        async function createCSVBlob(content) {
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const contentArray = new TextEncoder().encode(content);
            const combined = new Uint8Array(bom.length + contentArray.length);
            combined.set(bom);
            combined.set(contentArray, bom.length);
            return new Blob([combined], { type: 'text/csv;charset=utf-8' });
        }

        // „Éï„Ç°„Ç§„É´„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        async function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;

            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // ÂèéÈõÜ„Åó„Åü„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åô„ÇãÈÖçÂàó
        let collectedData = [];

        // Â±•Ê≠¥„Éá„Éº„Çø„ÇíËß£Êûê„Åó„Å¶Ë°®Á§∫ÔºàÊàª„ÇäÂÄ§: Âá¶ÁêÜ„Åó„Åü„É¨„Ç≥„Éº„ÉâÊï∞Ôºâ
        function parseHistoricalData(dataValue) {
            try {
                const data = new DataView(dataValue.buffer);
                const recordCount = data.getUint8(0);

                if (recordCount === 0) return 0;

                let offset = 1;
                for (let i = 0; i < recordCount; i++) {
                    // Unix Time (4bytes)
                    const timestamp = data.getUint32(offset, true);
                    offset += 4;

                    // Temperature (2bytes, 10ÂÄçÂÄ§)
                    const temp = data.getInt16(offset, true);
                    offset += 2;

                    // 4„Éê„Ç§„ÉàÂàÜ„Çπ„Ç≠„ÉÉ„ÉóÔºàÊπøÂ∫¶„Å®„Éê„ÉÉ„ÉÜ„É™„ÉºÔºâ
                    offset += 4;

                    // Ëß£Êûê„Åó„Åü„Éá„Éº„Çø„ÇíÈÖçÂàó„Å´ËøΩÂä†
                    collectedData.push({
                        timestamp: timestamp,
                        temperature: temp  // 10ÂÄçÂÄ§„Åß‰øùÂ≠ò
                    });
                }

                return recordCount;
            } catch (error) {
                showError(`Â±•Ê≠¥„Éá„Éº„ÇøËß£Êûê„Ç®„É©„Éº: ${error.message}`);
                return 0;
            }
        }

    </script>
</body>

</html>